<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>API Key Setup</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
	<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='assets/favicon/favicon.ico') }}">
</head>
<body>
	<div class="menu-bar-wrapper">
		<div class="menu-bar">
			<a href="/">Chat</a>
			<a href="/config">Config</a>
			<a href="/content">Content</a>
			<a href="/setup">API Keys</a>
		</div>
	</div>

	<div class="container">
		<h2>Enter Your API Keys</h2>
		<label for="modelSelect">Select Model:</label>
		<select id="modelSelect" onchange="loadExistingKey()">
			<option value="gemini">Gemini</option>
			<option value="openai">OpenAI</option>
			<option value="deepseek">DeepSeek</option>
		</select>
		<label for="apiKey">API Key:</label>
		<input type="text" id="apiKey" placeholder="Enter API Key">

		<button onclick="saveKeys()">Save and Continue</button>
	</div>

	<script>
		function loadExistingKey() {
			const model = document.getElementById('modelSelect').value;
			let existingKey = '';

			if (model === 'gemini') {
				existingKey = sessionStorage.getItem('geminiKey') || '';
			} else if (model === 'openai') {
				existingKey = sessionStorage.getItem('openaiKey') || '';
			} else if (model === 'deepseek') {
				existingKey = sessionStorage.getItem('deepseekKey') || '';
			}

			document.getElementById('apiKey').value = existingKey;
		}

		function saveKeys() {
			const model = document.getElementById('modelSelect').value;
			const key = document.getElementById('apiKey').value.trim();

			if (!key) {
				alert('Please enter an API key.');
				return;
			}

			// Persist API key in the database
			fetch('/api_key', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({model: model, key: key})
			})
			.then(response => {
				if (!response.ok) throw new Error('Failed to save API key');
				// Store locally for immediate use
				sessionStorage.setItem(`${model}Key`, key);
				sessionStorage.setItem('modelChoice', model);
				window.location.href = '/';
			})
			.catch(error => {
				console.error(error);
				alert('Error saving API key to database.');
			});
		}

		// Load the correct existing key on page load
		document.addEventListener('DOMContentLoaded', loadExistingKey);
	</script>
</body>
</html>
