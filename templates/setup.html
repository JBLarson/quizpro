<!DOCTYPE html>
<html lang="en">
<!-- Template: QuizPro setup page. Provides API key input, AI model selection, PPTX upload, and text-paste functionality. -->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Setup</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
	<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='assets/favicon/favicon.ico') }}">
</head>
<body>
	<div class="menu-bar-wrapper">
		<!-- Menu bar: includes theme toggle (dark/light mode) and logout link -->
		<div class="menu-bar">
			<button id="themeToggle" class="theme-toggle" type="button" title="Toggle light/dark mode">ðŸŒ“</button>
			<a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
		</div>
	</div>

	<div class="container">
		<!-- Main container for the setup card and form -->
		<div class="card">
			<h2 class="header">Setup Your Session</h2>

			<form method="POST" action="{{ url_for('setup') }}" enctype="multipart/form-data">
				<!-- Setup Form: submits API key, chosen model, PPTX file, and pasted text to backend -->
				<!-- API Key Section -->
				<div class="form-group">
					<!-- API Key Input: enter or update the user's AI service key (Gemini) -->
					<label for="apiKey">API Key:</label>
					<div class="input-with-button">
						<input class="form-control" type="text" id="apiKey" name="apiKey" placeholder="Enter API Key" required value="{{ keys.get('gemini', '') }}">
						<button type="button" id="saveKeyBtn" class="btn">Save API Key</button>
					</div>
				</div>

				<!-- LLM Model Selection -->
				<h3>Select LLM Model</h3>
				<!-- AI Model Selection: dropdown to pick which language model to use for question generation -->
				<label for="modelSelect">Model:</label>
				<select id="modelSelect" name="modelSelect" required>
					<option value="gemini">Gemini</option>
				</select>

				<!-- Upload PPTX Section -->
				<div class="form-group">
					<!-- Drag & Drop Multi-File Upload: support up to 5 files -->
					<label for="contentFile">Upload Content (up to 5 files):</label>
					<div id="dropZone" class="drop-zone" style="border: 2px dashed var(--input-border); padding: 20px; text-align: center; cursor: pointer; position: relative;">
						<p>Drag & drop files here, or click to select</p>
						<input type="file" id="contentFile" name="contentFile" accept=".pptx,.pdf,.docx,.xlsx,.txt,.csv,.csv" multiple title="Upload up to 5 content files" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
					</div>
					<div id="fileList" class="file-list" style="margin-top:8px;"></div>
				</div>
				<!-- Drag-and-drop script for multi-file upload -->
				<script>
				(function(){
					const dropZone = document.getElementById('dropZone');
					const fileInput = document.getElementById('contentFile');
					const fileList = document.getElementById('fileList');
					dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
					dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
					dropZone.addEventListener('drop', e => {
						e.preventDefault();
						dropZone.classList.remove('dragover');
						const files = Array.from(e.dataTransfer.files).slice(0,5);
						const dt = new DataTransfer();
						files.forEach(f => dt.items.add(f));
						fileInput.files = dt.files;
						updateFileList();
					});
					fileInput.addEventListener('change', updateFileList);
					function updateFileList(){
						fileList.innerHTML = '';
						Array.from(fileInput.files).slice(0,5).forEach(file => {
							const div = document.createElement('div');
							div.textContent = file.name;
							fileList.appendChild(div);
						});
						if(fileInput.files.length > 5){
							alert('You can only upload up to 5 files.');
							const dt2 = new DataTransfer();
							Array.from(fileInput.files).slice(0,5).forEach(f => dt2.items.add(f));
							fileInput.files = dt2.files;
							updateFileList();
						}
					}
				})();
				</script>
				
				<div class="form-group">
					<!-- Textarea: allows pasting or editing of extracted slide text -->
					<textarea class="form-control" name="pastedText" id="pastedText" rows="10" placeholder="Paste your text here...">{{ extracted_text or '' }}</textarea>
				</div>
				
				<button type="submit" class="btn">Submit All</button>
				<!-- Submit Button: finalize configuration and generate quiz questions -->
			</form>
		</div>  <!-- end card -->
	</div>  <!-- end container -->

	<!-- Config Section 
	<h3>Configure Chat Behavior</h3>

	<label for="tone">Tone:</label>
	<select id="tone" name="tone">
		<option value="formal">Formal</option>
		<option value="casual">Casual</option>
		<option value="friendly">Friendly</option>
	</select>

	<label for="difficulty">Difficulty:</label>
	<select id="difficulty" name="difficulty">
		<option value="easy">Easy</option>
		<option value="medium">Medium</option>
		<option value="hard">Hard</option>
	</select>

	<label for="style">Style:</label>
	<select id="style" name="style">
		<option value="multiple-choice">Multiple Choice</option>
		<option value="short-answer">Short Answer</option>
		<option value="free-response">Free Response</option>
	</select>

    <hr>

    <button onclick="saveConfig()">Save Config</button>


    -->



	<script>
		// Populate API key input based on selected model
		// Parse server-side API keys into JS object
		const apiKeys = JSON.parse('{{ keys|tojson|safe }}');
		const modelSelect = document.getElementById('modelSelect');
		const apiInput = document.getElementById('apiKey');
		function populateKey() {
			const model = modelSelect.value;
			apiInput.value = apiKeys[model] || '';
		}
		modelSelect.addEventListener('change', populateKey);
		document.addEventListener('DOMContentLoaded', populateKey);

		// Load existing API Key if available
		function loadExistingKey() {
			const model = document.getElementById('modelSelect').value;
			let existingKey = '';

			if (model === 'gemini') {
				existingKey = sessionStorage.getItem('geminiKey') || '';
			} else if (model === 'openai') {
				existingKey = sessionStorage.getItem('openaiKey') || '';
			} else if (model === 'deepseek') {
				existingKey = sessionStorage.getItem('deepseekKey') || '';
			}

			document.getElementById('apiKey').value = existingKey;
		}

		// Save API Key to database and update on page
		function saveKeys() {
			const model = document.getElementById('modelSelect').value;
			const key = document.getElementById('apiKey').value.trim();

			if (!key) {
				alert('Please enter an API key.');
				return;
			}

			fetch('/api_key', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({model: model, key: key})
			})
			.then(response => {
				if (!response.ok) throw new Error('Failed to save API key');
				// Update local JS store and dropdown
				apiKeys[model] = key;
				sessionStorage.setItem(`${model}Key`, key);
				sessionStorage.setItem('modelChoice', model);
				alert('API key saved!');
			})
			.catch(error => {
				console.error(error);
				alert('Error saving API key.');
			});
		}
		// Wire up Save API Key button
		document.getElementById('saveKeyBtn').addEventListener('click', saveKeys);

		// Upload PPTX
		function uploadPptx() {
			const fileInput = document.getElementById('pptxFile');
			const file = fileInput.files[0];
			sessionStorage.setItem('pptx_file', file);			
			if (!file) {
				alert('Please select a file.');
				return;
			}

			const formData = new FormData();
			formData.append('file', file);

			fetch('/upload_pptx', {
				method: 'POST',
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				sessionStorage.setItem('content', JSON.stringify(data.slides));
				alert('PPTX uploaded!');
			})
			.catch(error => {
				console.error('Error:', error);
				alert('Failed to upload PPTX.');
			});
		}

		// Save Pasted Text
		function saveText() {
			const text = document.getElementById('pastedText').value.trim();
			if (!text) {
				alert('Please paste some text.');
				return;
			}
			sessionStorage.setItem('content', text);
			alert('Text saved!');
		}

		// Save Config
		function saveConfig() {
			sessionStorage.setItem('tone', document.getElementById('tone').value);
			sessionStorage.setItem('difficulty', document.getElementById('difficulty').value);
			sessionStorage.setItem('style', document.getElementById('style').value);
			alert('Config saved!');
		}
	</script>
	<script>
		(function() {
			const toggle = document.getElementById('themeToggle');
			const root = document.documentElement;
			// Apply saved theme
			const current = localStorage.getItem('theme') || 'light';
			if (current === 'dark') root.classList.add('dark');
			// Toggle on click
			toggle.addEventListener('click', () => {
				root.classList.toggle('dark');
				const theme = root.classList.contains('dark') ? 'dark' : 'light';
				localStorage.setItem('theme', theme);
			});
		})();
	</script>
	<script>
		/* Auto-resize for pastedText textarea: grow from 100px to 200px, then scroll */
		const textarea = document.getElementById('pastedText');
		if (textarea) {
			const maxH = 200;
			textarea.style.height = '50px';
			textarea.style.overflowY = 'hidden';
			textarea.addEventListener('input', () => {
				textarea.style.height = 'auto';
				const newH = textarea.scrollHeight;
				if (newH > maxH) {
					textarea.style.height = maxH + 'px';
					textarea.style.overflowY = 'auto';
				} else {
					textarea.style.height = newH + 'px';
				}
			});
		}
	</script>
</body>
</html>
